{% extends 'blog/base.html' %}
{% load static %}

{% block title %}{{ post.title }} - MathMaster{% endblock %}

{% block content %}
<div class="content-card">
    <!-- –ó–∞–≥–æ–ª–æ–≤–æ–∫ –∏ –º–µ—Ç–∞-–∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è -->
    <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 1rem; flex-wrap: wrap; gap: 1rem;">
        <div>
            <span class="math-badge" style="background: {% if post.difficulty == 'beginner' %}#28a745{% elif post.difficulty == 'intermediate' %}#ffc107{% else %}#dc3545{% endif %}">
                {{ post.get_difficulty_display }}
            </span>
            {% if post.category %}
            <span class="math-badge" style="background: #6c757d;">
                {{ post.category.name }}
            </span>
            {% endif %}
        </div>
        <div style="color: #6c757d; font-size: 0.9rem;">
            ‚è±Ô∏è {{ post.reading_time }} –º–∏–Ω —á—Ç–µ–Ω–∏—è
        </div>
    </div>

    <h1 style="color: #3a0ca3; margin-bottom: 1rem; font-size: 2rem;">{{ post.title }}</h1>

    <!-- –ê–≤—Ç–æ—Ä –∏ –¥–∞—Ç–∞ -->
    <div style="display: flex; align-items: center; gap: 1rem; margin-bottom: 2rem; padding-bottom: 1rem; border-bottom: 2px solid #e9ecef;">
        <img src="https://cdn-icons-png.flaticon.com/512/847/847969.png" alt="–ê–≤—Ç–æ—Ä" style="width: 50px; height: 50px; border-radius: 50%;">
        <div>
            <div style="font-weight: 600; font-size: 1.1rem;">{{ post.author.username }}</div>
            <div style="color: #6c757d;">{{ post.created_date|date:"d.m.Y H:i" }}</div>
        </div>
    </div>

    <!-- –ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –ø–æ—Å—Ç–∞ -->
    {% if post.image %}
    <div style="text-align: center; margin-bottom: 2rem;">
        <img src="{{ post.image.url }}" alt="{{ post.title }}" style="max-width: 100%; border-radius: 10px; box-shadow: 0 4px 8px rgba(0,0,0,0.1);">
    </div>
    {% endif %}

    <!-- –û—Å–Ω–æ–≤–Ω–æ–µ —Å–æ–¥–µ—Ä–∂–∞–Ω–∏–µ -->
    <div style="margin-bottom: 3rem;">
        <h2 style="color: #4361ee; margin-bottom: 1rem;">üìù –°–æ–¥–µ—Ä–∂–∞–Ω–∏–µ</h2>
        <div style="background: #f8f9fa; padding: 1.5rem; border-radius: 10px; line-height: 1.7; font-size: 1.1rem;">
            {{ post.content|linebreaks }}
        </div>
    </div>

    <!-- –¢–µ–æ—Ä–µ—Ç–∏—á–µ—Å–∫–∞—è —á–∞—Å—Ç—å -->
    {% if post.theory_content %}
    <div style="margin-bottom: 3rem;">
        <h2 style="color: #4361ee; margin-bottom: 1rem;">üìö –¢–µ–æ—Ä–µ—Ç–∏—á–µ—Å–∫–∞—è —á–∞—Å—Ç—å</h2>
        <div style="background: #e8f4fd; padding: 1.5rem; border-radius: 10px; border-left: 5px solid #4361ee; line-height: 1.7; font-size: 1.1rem;">
            {{ post.theory_content|linebreaks }}
        </div>
    </div>
    {% endif %}

    <!-- –ü—Ä–∞–∫—Ç–∏—á–µ—Å–∫–∏–µ –∑–∞–¥–∞—á–∏ -->
    {% if post.problems.all %}
    <div style="margin-bottom: 3rem;">
        <h2 style="color: #4361ee; margin-bottom: 1rem;">üí™ –ü—Ä–∞–∫—Ç–∏—á–µ—Å–∫–∏–µ –∑–∞–¥–∞—á–∏</h2>

        {% for problem in post.problems.all %}
        <div class="post-card" style="margin-bottom: 2rem;">
            <h3 style="color: #3a0ca3; margin-bottom: 1rem;">
                –ó–∞–¥–∞—á–∞ {{ forloop.counter }}
            </h3>

            <div style="background: white; padding: 1.5rem; border-radius: 8px; border: 2px solid #e9ecef; margin-bottom: 1rem;">
                <p style="font-size: 1.1rem; margin-bottom: 0;"><strong>–£—Å–ª–æ–≤–∏–µ:</strong> {{ problem.question }}</p>
            </div>

            <!-- –§–æ—Ä–º–∞ –¥–ª—è –æ—Ç–≤–µ—Ç–∞ -->
            <div class="answer-section">
                <form class="answer-form" data-problem-id="{{ problem.id }}">
                    {% csrf_token %}
                    <div style="display: flex; gap: 1rem; align-items: start; margin-bottom: 1rem;">
                        <input type="text"
                               name="answer"
                               class="search-input"
                               placeholder="–í–≤–µ–¥–∏—Ç–µ –≤–∞—à –æ—Ç–≤–µ—Ç..."
                               style="flex: 1;"
                               id="answer-input-{{ problem.id }}">
                        <button type="submit" class="btn btn-primary check-answer-btn" id="check-btn-{{ problem.id }}">
                            –ü—Ä–æ–≤–µ—Ä–∏—Ç—å
                        </button>
                    </div>
                </form>

                <!-- –†–µ–∑—É–ª—å—Ç–∞—Ç –ø—Ä–æ–≤–µ—Ä–∫–∏ -->
                <div class="result-message" id="result-{{ problem.id }}" style="display: none; margin-top: 1rem; padding: 1rem; border-radius: 8px; font-weight: 600;"></div>

                <!-- –ü–æ–¥—Å–∫–∞–∑–∫–∞ -->
                {% if problem.hint %}
                <details style="margin-bottom: 1rem;">
                    <summary style="cursor: pointer; color: #4361ee; font-weight: 600; font-size: 1.1rem;">
                        üí° –ü–æ–∫–∞–∑–∞—Ç—å –ø–æ–¥—Å–∫–∞–∑–∫—É
                    </summary>
                    <div style="background: #fff3cd; padding: 1rem; border-radius: 8px; margin-top: 0.5rem; border-left: 3px solid #ffc107;">
                        <strong style="color: #856404;">–ü–æ–¥—Å–∫–∞–∑–∫–∞:</strong>
                        <p style="margin: 0.5rem 0 0 0; color: #856404;">{{ problem.hint }}</p>
                    </div>
                </details>
                {% endif %}

                <!-- –†–µ—à–µ–Ω–∏–µ (–ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –ø–æ—Å–ª–µ –ø—Ä–∞–≤–∏–ª—å–Ω–æ–≥–æ –æ—Ç–≤–µ—Ç–∞) -->
                <div class="solution-section" id="solution-{{ problem.id }}" style="display: none;">
                    <div style="background: #d4edda; padding: 1.5rem; border-radius: 8px; margin-top: 1rem; border-left: 4px solid #28a745;">
                        <h4 style="color: #155724; margin-bottom: 1rem;">‚úÖ –ü—Ä–∞–≤–∏–ª—å–Ω–æ! –†–µ—à–µ–Ω–∏–µ:</h4>
                        <div style="line-height: 1.6; color: #155724;">
                            {{ problem.solution|linebreaks }}
                        </div>
                    </div>
                </div>
            </div>
        </div>
        {% endfor %}
    </div>
    {% endif %}

    <!-- –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏ -->
    <div>
        <h2 style="color: #4361ee; margin-bottom: 1rem;">üí¨ –û–±—Å—É–∂–¥–µ–Ω–∏–µ</h2>

        <!-- –§–æ—Ä–º–∞ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è -->
        <div class="post-card">
            <h3 style="color: #3a0ca3; margin-bottom: 1rem;">–î–æ–±–∞–≤–∏—Ç—å –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π</h3>
            <form method="post">
                {% csrf_token %}
                <div style="margin-bottom: 1rem;">
                    <input type="text" name="author" placeholder="–í–∞—à–µ –∏–º—è" class="search-input" style="margin-bottom: 1rem;">
                    <textarea name="text" placeholder="–í–∞—à –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π..." class="search-input" style="height: 100px; resize: vertical;"></textarea>
                </div>
                <button type="submit" class="btn btn-primary">–û—Ç–ø—Ä–∞–≤–∏—Ç—å –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π</button>
            </form>
        </div>

        <!-- –°–ø–∏—Å–æ–∫ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤ -->
        {% for comment in comments %}
        <div class="post-card">
            <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
                <strong style="color: #3a0ca3;">{{ comment.author }}</strong>
                <small style="color: #6c757d;">{{ comment.created_date|date:"d.m.Y H:i" }}</small>
            </div>
            <p style="line-height: 1.6;">{{ comment.text }}</p>

            {% if user.is_superuser or user.username == comment.author %}
            <div style="margin-top: 0.5rem;">
                <a href="{% url 'delete_comment' comment.id %}" class="btn" style="background: #dc3545; color: white; padding: 0.3rem 0.8rem; font-size: 0.9rem;">
                    –£–¥–∞–ª–∏—Ç—å
                </a>
            </div>
            {% endif %}
        </div>
        {% empty %}
        <div class="post-card" style="text-align: center;">
            <p style="color: #6c757d; font-size: 1.1rem;">–ü–æ–∫–∞ –Ω–µ—Ç –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤. –ë—É–¥—å—Ç–µ –ø–µ—Ä–≤—ã–º!</p>
        </div>
        {% endfor %}
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // –û–±—Ä–∞–±–æ—Ç–∫–∞ —Ñ–æ—Ä–º –æ—Ç–≤–µ—Ç–æ–≤
    document.querySelectorAll('.answer-form').forEach(form => {
        form.addEventListener('submit', function(e) {
            e.preventDefault();
            const problemId = this.dataset.problemId;
            const answerInput = document.getElementById(`answer-input-${problemId}`);
            const checkBtn = document.getElementById(`check-btn-${problemId}`);
            const resultMessage = document.getElementById(`result-${problemId}`);
            const solutionSection = document.getElementById(`solution-${problemId}`);

            const answer = answerInput.value.trim();
            if (!answer) {
                showResult(resultMessage, '‚ùå –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ –æ—Ç–≤–µ—Ç', 'error');
                return;
            }

            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∑–∞–≥—Ä—É–∑–∫—É
            checkBtn.disabled = true;
            checkBtn.textContent = '–ü—Ä–æ–≤–µ—Ä—è–µ–º...';

            // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∑–∞–ø—Ä–æ—Å –Ω–∞ –ø—Ä–æ–≤–µ—Ä–∫—É
            fetch(`/check-answer/${problemId}/`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                    'X-CSRFToken': this.querySelector('[name=csrfmiddlewaretoken]').value
                },
                body: `answer=${encodeURIComponent(answer)}`
            })
            .then(response => response.json())
            .then(data => {
                if (data.is_correct) {
                    // –ü–†–ê–í–ò–õ–¨–ù–´–ô –û–¢–í–ï–¢ - –ó–ï–õ–ï–ù–´–ô
                    showResult(resultMessage, data.feedback, 'success');

                    // –ü–û–ö–ê–ó–´–í–ê–ï–ú –†–ï–®–ï–ù–ò–ï –¢–û–õ–¨–ö–û –ü–†–ò –ü–†–ê–í–ò–õ–¨–ù–û–ú –û–¢–í–ï–¢–ï
                    solutionSection.style.display = 'block';

                    answerInput.disabled = true;
                    checkBtn.disabled = true;
                    checkBtn.textContent = '–†–µ—à–µ–Ω–æ!';
                    checkBtn.style.background = '#28a745';
                } else {
                    // –ù–ï–ü–†–ê–í–ò–õ–¨–ù–´–ô –û–¢–í–ï–¢ - –ö–†–ê–°–ù–´–ô
                    showResult(resultMessage, data.feedback, 'error');

                    // –†–ï–®–ï–ù–ò–ï –ù–ï –ü–û–ö–ê–ó–´–í–ê–ï–ú –ü–†–ò –ù–ï–ü–†–ê–í–ò–õ–¨–ù–û–ú –û–¢–í–ï–¢–ï
                    solutionSection.style.display = 'none';
                }
            })
            .catch(error => {
                showResult(resultMessage, '‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –ø—Ä–æ–≤–µ—Ä–∫–µ –æ—Ç–≤–µ—Ç–∞', 'error');
                solutionSection.style.display = 'none';
            })
            .finally(() => {
                if (!answerInput.disabled) {
                    checkBtn.disabled = false;
                    checkBtn.textContent = '–ü—Ä–æ–≤–µ—Ä–∏—Ç—å';
                }
            });
        });
    });

    function showResult(element, message, type) {
        element.style.display = 'block';
        element.textContent = message;
        element.style.fontWeight = '600';

        if (type === 'success') {
            // –ó–ï–õ–ï–ù–´–ô –¥–ª—è –ø—Ä–∞–≤–∏–ª—å–Ω—ã—Ö –æ—Ç–≤–µ—Ç–æ–≤
            element.style.background = '#d4edda';
            element.style.color = '#155724';
            element.style.border = '2px solid #28a745';
        } else {
            // –ö–†–ê–°–ù–´–ô –¥–ª—è –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã—Ö –æ—Ç–≤–µ—Ç–æ–≤
            element.style.background = '#f8d7da';
            element.style.color = '#721c24';
            element.style.border = '2px solid #dc3545';

            // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–∫—Ä—ã–≤–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –æ–± –æ—à–∏–±–∫–µ —á–µ—Ä–µ–∑ 5 —Å–µ–∫—É–Ω–¥
            setTimeout(() => {
                element.style.display = 'none';
            }, 5000);
        }
    }
});
</script>
{% endblock %}